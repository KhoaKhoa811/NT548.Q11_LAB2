name: 'Checkov Security Scan'

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'exercise_1/**'
      - '.checkov.yml'

jobs:
  checkov-scan:
    name: 'ğŸ”’ Checkov Security Scan'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: exercise_1/
          framework: terraform
          config_file: .checkov.yml
          output_format: cli,json,sarif
          output_file_path: console,checkov-results.json,checkov-results.sarif
          soft_fail: true
          download_external_modules: true
          log_level: WARNING

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-results.sarif
        continue-on-error: true

      - name: Upload Checkov JSON Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-json-report
          path: checkov-results.json
          retention-days: 30

      - name: Parse Checkov Results
        id: parse
        if: always()
        run: |
          if [ -f checkov-results.json ]; then
            PASSED=$(cat checkov-results.json | jq '[.results.passed_checks // [] | length] | add // 0')
            FAILED=$(cat checkov-results.json | jq '[.results.failed_checks // [] | length] | add // 0')
            SKIPPED=$(cat checkov-results.json | jq '[.results.skipped_checks // [] | length] | add // 0')
            echo "passed=${PASSED}" >> $GITHUB_OUTPUT
            echo "failed=${FAILED}" >> $GITHUB_OUTPUT
            echo "skipped=${SKIPPED}" >> $GITHUB_OUTPUT
          else
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "skipped=0" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with Checkov Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const passed = '${{ steps.parse.outputs.passed }}';
            const failed = '${{ steps.parse.outputs.failed }}';
            const skipped = '${{ steps.parse.outputs.skipped }}';
            
            let statusEmoji = 'âœ…';
            let statusText = 'All security checks passed!';
            
            if (parseInt(failed) > 0) {
              statusEmoji = 'âš ï¸';
              statusText = `${failed} security issue(s) found. Please review.`;
            }
            
            const output = `## ğŸ”’ Checkov Security Scan Results
            
            ${statusEmoji} **Status:** ${statusText}
            
            | Metric | Count |
            |--------|-------|
            | âœ… Passed | ${passed} |
            | âŒ Failed | ${failed} |
            | â­ï¸ Skipped | ${skipped} |
            
            ---
            
            ğŸ“ **Note:** To skip a specific check, add inline comment in your Terraform code:
            \`\`\`hcl
            #checkov:skip=CKV_AWS_XX:Reason for skipping
            \`\`\`
            
            ğŸ“Š [View detailed report in Artifacts](../actions/runs/${{ github.run_id }})
            
            *Scan triggered by: @${{ github.actor }}*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Fail if critical issues found
        if: steps.checkov.outcome == 'failure'
        run: |
          echo "âš ï¸ Checkov found security issues. Please review the results above."
          echo "You can skip specific checks with justification using #checkov:skip=CKV_XXX:reason"
          exit 0  # Set to exit 1 if you want to block PRs with security issues
