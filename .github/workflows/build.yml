name: 'Build AWS Infrastructure'

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
      confirm:
        description: 'Type "build" to confirm deployment'
        required: true
        type: string

env:
  TF_VERSION: '1.5.0'
  TF_WORKING_DIR: 'exercise_1'
  AWS_REGION: 'us-east-1'

jobs:
  validate-build:
    name: 'âœ… Validate Build Request'
    runs-on: ubuntu-latest
    outputs:
      confirmed: ${{ steps.check.outputs.confirmed }}
    steps:
      - name: Validate confirmation
        id: check
        run: |
          if [ "${{ github.event.inputs.confirm }}" == "build" ]; then
            echo "confirmed=true" >> $GITHUB_OUTPUT
            echo "âœ… Build confirmed for ${{ github.event.inputs.environment }}"
          else
            echo "confirmed=false" >> $GITHUB_OUTPUT
            echo "âŒ Invalid confirmation. Expected 'build', got '${{ github.event.inputs.confirm }}'"
            exit 1
          fi

  security-scan:
    name: 'ðŸ”’ Security Scan (Checkov)'
    runs-on: ubuntu-latest
    needs: validate-build
    if: needs.validate-build.outputs.confirmed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: exercise_1/
          framework: terraform
          output_format: cli,json
          output_file_path: console,checkov-results.json
          soft_fail: true
          download_external_modules: true

      - name: Upload Checkov Report
        uses: actions/upload-artifact@v4
        with:
          name: checkov-build-report
          path: checkov-results.json
          retention-days: 30

  terraform-plan:
    name: 'ðŸ“‹ Terraform Plan'
    runs-on: ubuntu-latest
    needs: security-scan
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Validate
        run: terraform validate -no-color
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Plan
        id: plan
        run: |
          echo "ðŸ” Planning infrastructure for ${{ github.event.inputs.environment }}..."
          terraform plan -no-color -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        working-directory: ${{ env.TF_WORKING_DIR }}
        continue-on-error: true

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-build-plan
          path: |
            ${{ env.TF_WORKING_DIR }}/tfplan
            ${{ env.TF_WORKING_DIR }}/plan_output.txt
          retention-days: 7

  terraform-apply:
    name: 'ðŸš€ Build AWS Infrastructure'
    runs-on: ubuntu-latest
    needs: terraform-plan
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: terraform-build-plan
          path: ${{ env.TF_WORKING_DIR }}

      - name: Build Infrastructure
        id: apply
        run: |
          echo "ðŸ—ï¸ Building AWS Infrastructure..."
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Time: $(date -u)"
          echo "---"
          terraform apply -auto-approve tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Get Terraform Outputs
        id: outputs
        run: |
          echo "ðŸ“Š Infrastructure Outputs:"
          echo "=========================="
          terraform output -json > terraform-outputs.json
          terraform output
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Upload Outputs Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-build-outputs
          path: ${{ env.TF_WORKING_DIR }}/terraform-outputs.json
          retention-days: 30

      - name: Build Summary
        run: |
          echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u) |" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Resources Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VPC & Networking" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security Groups" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NAT Gateway" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… EC2 Instances (Bastion & App Server)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… EKS Cluster with Node Groups" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… S3 Bucket for Terraform State" >> $GITHUB_STEP_SUMMARY

